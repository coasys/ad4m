# File Storage Language Tests - Uses Docker container for consistent environment

name: File Storage

on:
  push:
    branches:
      - main
      - staging
      - bootstrap-languages

jobs:
  holochain:
    name: Holochain Tests
    runs-on: ubuntu-latest
    container:
      image: coasys/ad4m-ci-linux:latest@sha256:3d6e8b6357224d689345eebd5f9da49ee5fd494b3fd976273d0cf5528f6903ab

    steps:
    - uses: actions/checkout@v3

    # Rust toolchain configured via rust-toolchain.toml
    - name: Verify Rust toolchain
      run: rustc --version && cargo --version && hc --version

    - name: Install dependencies
      env:
        npm_config_build_from_source: true
      run: pnpm install --no-frozen-lockfile

    - name: Build languages
      run: pnpm run build-languages

    - name: Run tests
      run: |
        cd bootstrap-languages/file-storage/hc-dna/tests
        pnpm install --no-frozen-lockfile --shamefully-hoist
        pnpm run test

  integration:
    name: Integration Test
    runs-on: ubuntu-latest
    container:
      image: coasys/ad4m-ci-linux:latest@sha256:3d6e8b6357224d689345eebd5f9da49ee5fd494b3fd976273d0cf5528f6903ab

    steps:
    - uses: actions/checkout@v3

    # Rust toolchain configured via rust-toolchain.toml
    - name: Verify Rust toolchain
      run: rustc --version && cargo --version && hc --version

    - name: Install dependencies
      env:
        npm_config_build_from_source: true
      run: pnpm install --no-frozen-lockfile

    - name: Build
      run: pnpm run build

    - name: Run integration tests
      run: cd bootstrap-languages/file-storage && pnpm run integration-test
