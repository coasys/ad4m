# P-Diff-Sync Language Tests - Uses Docker container for consistent environment

name: P Diff Sync

on:
  push:
    branches:
      - main
      - staging
      - bootstrap-languages

jobs:
  unit:
    name: Rust Unit Test
    runs-on: ubuntu-latest
    container:
      image: coasys/ad4m-ci-linux:latest@sha256:3d6e8b6357224d689345eebd5f9da49ee5fd494b3fd976273d0cf5528f6903ab

    steps:
    - uses: actions/checkout@v3

    # Rust toolchain configured via rust-toolchain.toml
    - name: Verify Rust toolchain
      run: rustc --version && cargo --version

    - name: Run unit tests
      run: cd bootstrap-languages/p-diff-sync/hc-dna && cargo test -- --test-threads=1

  pull:
    name: Pull Test
    runs-on: ubuntu-latest
    container:
      image: coasys/ad4m-ci-linux:latest@sha256:3d6e8b6357224d689345eebd5f9da49ee5fd494b3fd976273d0cf5528f6903ab

    steps:
    - uses: actions/checkout@v3

    - name: Verify Rust toolchain
      run: rustc --version && cargo --version && hc --version

    - name: Install dependencies
      env:
        npm_config_build_from_source: true
      run: pnpm install --no-frozen-lockfile

    - name: Build languages
      run: pnpm run build-languages

    - name: Run tests
      run: cd bootstrap-languages/p-diff-sync/hc-dna/zomes/tests && pnpm install --no-frozen-lockfile && pnpm run test-pull

  render:
    name: Render Test
    runs-on: ubuntu-latest
    container:
      image: coasys/ad4m-ci-linux:latest@sha256:3d6e8b6357224d689345eebd5f9da49ee5fd494b3fd976273d0cf5528f6903ab

    steps:
    - uses: actions/checkout@v3

    - name: Verify Rust toolchain
      run: rustc --version && cargo --version && hc --version

    - name: Install dependencies
      env:
        npm_config_build_from_source: true
      run: pnpm install --no-frozen-lockfile

    - name: Build languages
      run: pnpm run build-languages

    - name: Run tests
      run: cd bootstrap-languages/p-diff-sync/hc-dna/zomes/tests && pnpm install --no-frozen-lockfile && pnpm run test-render

  revisions:
    name: Revisions Test
    runs-on: ubuntu-latest
    container:
      image: coasys/ad4m-ci-linux:latest@sha256:3d6e8b6357224d689345eebd5f9da49ee5fd494b3fd976273d0cf5528f6903ab

    steps:
    - uses: actions/checkout@v3

    - name: Verify Rust toolchain
      run: rustc --version && cargo --version && hc --version

    - name: Install dependencies
      env:
        npm_config_build_from_source: true
      run: pnpm install --no-frozen-lockfile

    - name: Build languages
      run: pnpm run build-languages

    - name: Run tests
      run: cd bootstrap-languages/p-diff-sync/hc-dna/zomes/tests && pnpm install --no-frozen-lockfile && pnpm run test-revisions

  signals:
    name: Signals Test
    runs-on: ubuntu-latest
    container:
      image: coasys/ad4m-ci-linux:latest@sha256:3d6e8b6357224d689345eebd5f9da49ee5fd494b3fd976273d0cf5528f6903ab

    steps:
    - uses: actions/checkout@v3

    - name: Verify Rust toolchain
      run: rustc --version && cargo --version && hc --version

    - name: Install dependencies
      env:
        npm_config_build_from_source: true
      run: pnpm install --no-frozen-lockfile

    - name: Build languages
      run: pnpm run build-languages

    - name: Run tests
      run: cd bootstrap-languages/p-diff-sync/hc-dna/zomes/tests && pnpm install --no-frozen-lockfile && pnpm run test-signals

  stress:
    name: Stress Test
    runs-on: ubuntu-latest
    container:
      image: coasys/ad4m-ci-linux:latest@sha256:3d6e8b6357224d689345eebd5f9da49ee5fd494b3fd976273d0cf5528f6903ab

    steps:
    - uses: actions/checkout@v3

    - name: Verify Rust toolchain
      run: rustc --version && cargo --version && hc --version

    - name: Install dependencies
      env:
        npm_config_build_from_source: true
      run: pnpm install --no-frozen-lockfile

    - name: Build languages
      run: pnpm run build-languages

    - name: Run tests
      run: cd bootstrap-languages/p-diff-sync/hc-dna/zomes/tests && pnpm install --no-frozen-lockfile && pnpm run test-stress

  telepresence:
    name: Telepresence Test
    runs-on: ubuntu-latest
    container:
      image: coasys/ad4m-ci-linux:latest@sha256:3d6e8b6357224d689345eebd5f9da49ee5fd494b3fd976273d0cf5528f6903ab

    steps:
    - uses: actions/checkout@v3

    - name: Verify Rust toolchain
      run: rustc --version && cargo --version && hc --version

    - name: Install dependencies
      env:
        npm_config_build_from_source: true
      run: pnpm install --no-frozen-lockfile

    - name: Build languages
      run: pnpm run build-languages

    - name: Run tests
      run: cd bootstrap-languages/p-diff-sync/hc-dna/zomes/tests && pnpm install --no-frozen-lockfile && pnpm run test-telepresence
