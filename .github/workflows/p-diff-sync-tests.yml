# P Diff Sync Tests - Using CircleCI Docker Image

name: P Diff Sync

on:
  push:
    branches:
      - main
      - staging
      - bootstrap-languages

jobs:
  rust-tests:
    name: Rust Tests (Unit + Integration)
    runs-on: ubuntu-22.04
    container:
      image: coasys/ad4m-ci-linux:latest@sha256:d0c3e9683811505955185782a5cd683952f846f1abc520c35c1293ad7f046593

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Cache Rust dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            bootstrap-languages/p-diff-sync/hc-dna/target/
          key: ${{ runner.os }}-p-diff-sync-rust-${{ hashFiles('bootstrap-languages/p-diff-sync/hc-dna/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-p-diff-sync-rust-

      - name: Build DNA
        working-directory: bootstrap-languages/p-diff-sync/hc-dna
        run: bash build.sh

      - name: Run unit tests
        working-directory: bootstrap-languages/p-diff-sync/hc-dna
        run: cargo test --lib -- --test-threads=1

      - name: Run sweettest integration tests
        working-directory: bootstrap-languages/p-diff-sync/hc-dna/tests/sweettest
        run: cargo test --test integration

      - name: Save Rust cache
        if: success()
        uses: actions/cache/save@v3
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            bootstrap-languages/p-diff-sync/hc-dna/target/
          key: ${{ runner.os }}-p-diff-sync-rust-${{ hashFiles('bootstrap-languages/p-diff-sync/hc-dna/Cargo.lock') }}
