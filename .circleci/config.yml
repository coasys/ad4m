version: 2.1
references:
  ad4m_image: &ad4m_image coasys/ad4m-ci-linux:latest@sha256:3d6e8b6357224d689345eebd5f9da49ee5fd494b3fd976273d0cf5528f6903ab

commands:
  setup_integration_test_environment:
    description: "Setup common integration test environment with caches, installs, and builds"
    steps:
      - checkout
      - attach_workspace:
          at: .
      - restore_cache:
          keys:
            - agent-language-rust-cache-{{ checksum "bootstrap-languages/agent-language/hc-dna/Cargo.lock" }}
            - agent-language-rust-cache-
      - restore_cache:
          keys:
            - direct-message-language-rust-cache-{{ checksum "bootstrap-languages/direct-message-language/hc-dna/Cargo.lock" }}
            - direct-message-language-rust-cache-
      - restore_cache:
          keys:
            - file-storage-rust-cache-{{ checksum "bootstrap-languages/file-storage/hc-dna/Cargo.lock" }}
            - file-storage-rust-cache-
      - restore_cache:
          keys:
            - p-diff-sync-rust-cache-{{ checksum "bootstrap-languages/p-diff-sync/hc-dna/Cargo.lock" }}
            - p-diff-sync-rust-cache-
      - restore_cache:
          keys:
            - p-diff-sync-socket-signaling-rust-cache-{{ checksum "bootstrap-languages/p-diff-sync-socket-signaling/hc-dna/Cargo.lock" }}
            - p-diff-sync-socket-signaling-rust-cache-
      - run:
          name: Install specific pnpm version
          command: npm install -g pnpm@9.15.0
      - run:
          name: Install dependencies
          command: pnpm install --no-frozen-lockfile
      - run:
          name: Install core dependencies
          command: cd ./core && pnpm install --no-frozen-lockfile
      - run:
          name: Build bootstrap languages
          command: pnpm run build-languages
      - save_cache:
          key: agent-language-rust-cache-{{ checksum "bootstrap-languages/agent-language/hc-dna/Cargo.lock" }}
          paths:
            - ./bootstrap-languages/agent-language/hc-dna/target
      - save_cache:
          key: direct-message-language-rust-cache-{{ checksum "bootstrap-languages/direct-message-language/hc-dna/Cargo.lock" }}
          paths:
            - ./bootstrap-languages/direct-message-language/hc-dna/target
      - save_cache:
          key: file-storage-rust-cache-{{ checksum "bootstrap-languages/file-storage/hc-dna/Cargo.lock" }}
          paths:
            - ./bootstrap-languages/file-storage-language/hc-dna/target
      - save_cache:
          key: p-diff-sync-rust-cache-{{ checksum "bootstrap-languages/p-diff-sync/hc-dna/Cargo.lock" }}
          paths:
            - ./bootstrap-languages/p-diff-sync/hc-dna/target
      - save_cache:
          key: p-diff-sync-socket-signaling-rust-cache-{{ checksum "bootstrap-languages/p-diff-sync-socket-signaling/hc-dna/Cargo.lock" }}
          paths:
            - ./bootstrap-languages/p-diff-sync-socket-signaling/hc-dna/target
      - run:
          name: Install ffmpeg for transcription test
          command: sudo apt-get update && sudo apt-get install ffmpeg --fix-missing

orbs:
  node: circleci/node@5.2.0
  go: circleci/go@1.10.0

jobs:
  build-and-test:
    docker:
      - image: *ad4m_image
    resource_class: xlarge
    steps:
      - checkout
      - restore_cache:
          keys:
            - rust-cache-{{ checksum "Cargo.lock" }}-1.88
            - rust-cache-
      - run:
          name: cargo fmt --check
          command: cargo fmt --check
      - run:
          name: Install dependencies
          command: pnpm install --no-frozen-lockfile
      - run:
          name: Build dapp
          command: pnpm build-dapp
      - run:
          name: Install core dependencies
          command: cd ./core && pnpm install --no-frozen-lockfile
      - run:
          name: Build core executor
          command: pnpm run build-core-executor
      - run:
          name: Build deno snapshot
          command: pnpm run build-deno-snapshot
          no_output_timeout: 30m
      - run:
          name: Build ADAM (without bootstrap languages)
          command: pnpm run build-libs
          no_output_timeout: 30m
      - run:
          name: cargo clippy
          no_output_timeout: 30m
          command: cargo clippy --all --exclude ad4m-launcher
      - save_cache:
          key: rust-cache-{{ checksum "Cargo.lock" }}-1.88
          paths:
            - ./target
            - ~/.cargo/registry
            - ~/.cargo/git
      - persist_to_workspace:
          no-output-timeout: 30m
          root: .
          paths:
            - ./target/release/ad4m
            - ./target/release/ad4m-executor
      - run:
          name: Remove pnpm patches
          command: node removePnpm.js
      - run:
          name: Install dependencies
          command: pnpm install --no-frozen-lockfile
      - run:
          name: Install core dependencies
          command: cd ./core && pnpm install --no-frozen-lockfile
      - run:
          name: Root tests
          command: pnpm test
          no_output_timeout: 30m

  integration-tests-js:
    docker:
      - image: *ad4m_image
    resource_class: xlarge
    steps:
      - setup_integration_test_environment
      - run:
          name: Run integration tests
          command: cd ./tests/js && pnpm run test-main
          no_output_timeout: 30m

  integration-tests-multi-user-simple:
    docker:
      - image: *ad4m_image
    resource_class: xlarge
    steps:
      - setup_integration_test_environment
      - run:
          name: Run multi-user-simple integration tests
          command: cd ./tests/js && ./test-multi-user-with-setup.sh
          no_output_timeout: 30m

  integration-tests-email-verification:
    docker:
      - image: *ad4m_image
    resource_class: xlarge
    steps:
      - setup_integration_test_environment
      - run:
          name: Run email-verification integration tests
          command: cd ./tests/js && ./email-verification-test-with-setup.sh
          no_output_timeout: 30m

  integration-tests-cli:
    docker:
      - image: *ad4m_image
    steps:
      - checkout
      - attach_workspace:
          at: .
      - run:
          name: git submodule
          command: git submodule update --init --recursive
      - run:
          name: Run binaries test script
          command: ./tests/bats/bin/bats tests/binaries.bats
      - run:
          name: Run integration test script
          command: ./tests/bats/bin/bats tests/integration.bats

workflows:
  version: 2
  build-and-test:
    jobs:
      - build-and-test
      - integration-tests-js:
          requires:
            - build-and-test
      - integration-tests-multi-user-simple:
          requires:
            - build-and-test
      - integration-tests-email-verification:
          requires:
            - build-and-test
